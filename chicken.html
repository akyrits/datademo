<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hen & Rooster Pen</title>
<style>
  :root{
    --bg:#7cfc00;
    --pen:#f4f1de;
    --wood:#8b4513;
    --text:#1f2937;
    --panel:#ffffffcc;
    --ok:#10b981;
    --warn:#ef4444;
    --ufo:#8b5cf6;
  }
  *{box-sizing:border-box}
  body{
    display:flex; flex-direction:column; align-items:center; gap:12px;
    background: radial-gradient(1200px 800px at 50% -200px, #b3ff9e, var(--bg));
    min-height:100vh; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text);
    transition: background-color .2s;
  }
  body.hurt { animation: hurtFlash .25s; }
  @keyframes hurtFlash { 0%{background-color:#ffb3b3;} 100%{background-color:transparent;} }

  /* Screen shake for UFO impact */
  .shake { animation: shake 500ms ease-in-out; }
  @keyframes shake {
    0% { transform: translate(0,0); }
    20% { transform: translate(-4px, 2px) rotate(-0.6deg); }
    40% { transform: translate(5px, -3px) rotate(0.6deg); }
    60% { transform: translate(-3px, 2px) rotate(-0.4deg); }
    80% { transform: translate(3px, -2px) rotate(0.4deg); }
    100% { transform: translate(0,0); }
  }

  h1{ margin:12px 0 0; font-weight:800; letter-spacing:.4px; }
  .sub { margin:0; color:#374151; opacity:.8; text-align:center; }

  .topbar{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center;
  }
  .trophy{
    background:#fff; padding:6px 10px; border-radius:12px; box-shadow:0 6px 18px #0002;
    font-weight:700;
  }

  .hud{
    display:flex; gap:18px; align-items:center; font-size:1.05rem; flex-wrap:wrap;
    background:var(--panel); padding:8px 12px; border-radius:12px; box-shadow:0 6px 20px #0001;
  }
  .pill{ display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#fff; box-shadow:inset 0 0 0 1px #00000014; }
  .pill b{font-variant-numeric:tabular-nums}
  .lives{ letter-spacing:2px; }
  .badge{padding:4px 8px; border-radius:8px; font-size:.9rem; background:#fff; box-shadow:inset 0 0 0 1px #00000014;}

  .pen{
    position:relative; width:min(92vw, 560px); aspect-ratio:5/4; max-height:70vh;
    background:var(--pen); border:12px solid var(--wood); border-radius:16px; overflow:hidden;
    box-shadow:0 12px 30px #0002, inset 0 0 0 4px #0000000f;
    touch-action:manipulation;
  }
  .fence{
    position:absolute; inset:0; pointer-events:none; background:
      linear-gradient(90deg, #0000 94%, #0000000f 94% 96%, #0000 96%),
      repeating-linear-gradient(#0000 0 18px, #0000000c 18px 19px);
  }

  /* Actor wrapper + hit circle */
  .actor{ position:absolute; width:1px; height:1px; transition: opacity .35s; }
  .emoji{
    position:absolute; left:0; top:0;
    font-size:2rem; transform: translate(-50%,-50%);
    user-select:none; pointer-events:none;
  }
  .hit{
    --r: 2.6rem;
    position:absolute; left:0; top:0; width:var(--r); height:var(--r);
    transform: translate(-50%, -50%); border-radius:50%; cursor:pointer;
    background: rgba(0,0,0,0);
  }
  .actor:has(.hit:hover) .emoji{ transform: translate(-50%,-50%) scale(1.06); }

  /* Cow danger halo pulse */
  .cowHalo::after{
    content:"";
    position:absolute; left:0; top:0; width:3.2rem; height:3.2rem; transform:translate(-50%,-50%);
    border-radius:50%; box-shadow:0 0 0 2px var(--ufo) inset, 0 0 10px 2px rgba(139,92,246,.35);
    animation: halo 1100ms ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes halo {
    0%   { box-shadow:0 0 0 0 var(--ufo) inset, 0 0 6px 1px rgba(139,92,246,.2); opacity:.9; }
    50%  { box-shadow:0 0 0 3px var(--ufo) inset, 0 0 14px 3px rgba(139,92,246,.45); opacity:1; }
    100% { box-shadow:0 0 0 0 var(--ufo) inset, 0 0 6px 1px rgba(139,92,246,.2); opacity:.9; }
  }

  .drop{ position:absolute; font-size:1.5rem; pointer-events:none; filter: drop-shadow(0 4px 6px #0003); }

  .overlay{
    position:fixed; inset:0; display:grid; place-items:center; background:#0008; z-index:10; padding:20px;
  }
  .card{
    width:min(92vw,560px); background:#fff; border-radius:16px; padding:22px; text-align:center;
    box-shadow:0 20px 50px #0006;
  }
  .row{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
  .btn{
    border:0; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700; font-size:1rem;
    box-shadow:0 6px 18px #0002; transition: transform .06s, box-shadow .2s, opacity .2s;
  }
  .btn:active{ transform: translateY(1px) scale(0.99); }
  .btn.primary{ background:linear-gradient(180deg, #34d399, #10b981); color:white; }
  .btn.warn{ background:linear-gradient(180deg, #f97316, #ef4444); color:white; }
  .btn.ghost{ background:#eef2ff; color:#111827; }
  .small{ font-size:.9rem; opacity:.8; }
  input[type="text"]{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e5e7eb; font-size:1rem; outline:none;
  }

  .toast{
    position:fixed; top:14px; right:14px; background:#111827; color:#fff; padding:8px 12px; border-radius:10px; font-size:.9rem; opacity:.95; z-index:9;
    box-shadow:0 8px 20px #0006;
  }

  .lb{ text-align:left; margin-top:10px; border-top:1px solid #e5e7eb; padding-top:10px; max-height:220px; overflow:auto; }
  .lb table{ width:100%; border-collapse:collapse; }
  .lb th, .lb td{ padding:6px 8px; font-size:.95rem; }
  .lb tr:nth-child(even){ background:#f9fafb; }
  .lb .rank{ width:3ch; text-align:right; font-variant-numeric:tabular-nums; }
  .lb .score{ text-align:right; font-variant-numeric:tabular-nums; }
</style>
</head>
<body>
  <h1>Hen & Rooster Pen</h1>
  <div class="topbar">
    <div class="trophy" id="trophy">üèÜ High Score: ‚Äî</div>
  </div>
  <p class="sub">Click only <b>hens üêî</b> and <b>roosters üêì</b>. Anything else costs a life. <b>Never touch cows üêÑ</b>‚Ä¶</p>

  <div class="hud">
    <div class="pill">ü•ö Eggs: <b id="eggCount">0</b></div>
    <div class="pill">ü™∂ Feathers: <b id="featherCount">0</b></div>
    <div class="pill">üî• Streak: <b id="streak">0</b></div>
    <div class="pill">‚≠ê Score: <b id="score">0</b></div>
    <div class="pill">‚ù§Ô∏è Lives: <b class="lives" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</b></div>
    <div class="badge">Mode: <span id="modeLabel">‚Äî</span></div>
    <div class="badge">Player: <span id="playerLabel">‚Äî</span></div>
  </div>

  <div class="pen" id="pen">
    <div class="fence"></div>
  </div>

  <!-- Start Menu + Username -->
  <div class="overlay" id="menu">
    <div class="card">
      <h2>Welcome to the Pen</h2>
      <p class="small">Enter a name and pick your mode.</p>
      <div style="margin:10px 0;">
        <input id="nameInput" type="text" placeholder="Your name (3‚Äì16 chars)" maxlength="16" />
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="btn primary" data-mode="normal" disabled>Normal</button>
        <button class="btn warn" data-mode="chaos" disabled>Chaos</button>
        <button class="btn ghost" id="viewLB">View Leaderboard</button>
      </div>
      <div class="lb" id="lbPreview" style="display:none;"></div>
    </div>
  </div>

  <!-- Game Over -->
  <div class="overlay" id="gameover" style="display:none;">
    <div class="card">
      <h2>Game Over</h2>
      <p>You ran out of lives‚Äîor a UFO crashed the coop.</p>
      <p><b>Eggs:</b> <span id="finalEggs">0</span> &nbsp;‚Ä¢&nbsp;
         <b>Feathers:</b> <span id="finalFeathers">0</span> &nbsp;‚Ä¢&nbsp;
         <b>Score:</b> <span id="finalScore">0</span></p>
      <div class="row" style="margin-top:12px;">
        <button class="btn ghost" id="restart">Play Again</button>
        <button class="btn primary" id="seeLB">Leaderboard</button>
      </div>
      <div class="lb" id="lbEnd" style="display:none;"></div>
    </div>
  </div>

  <div class="toast" id="toast" style="display:none;">Life lost! Only click üêî or üêì</div>

<script>
  // --------- DOM refs
  const pen = document.getElementById('pen');
  const eggCountEl = document.getElementById('eggCount');
  const featherCountEl = document.getElementById('featherCount');
  const livesEl = document.getElementById('lives');
  const modeLabel = document.getElementById('modeLabel');
  const playerLabel = document.getElementById('playerLabel');
  const menu = document.getElementById('menu');
  const gameover = document.getElementById('gameover');
  const finalEggs = document.getElementById('finalEggs');
  const finalFeathers = document.getElementById('finalFeathers');
  const finalScore = document.getElementById('finalScore');
  const restartBtn = document.getElementById('restart');
  const toast = document.getElementById('toast');
  const trophy = document.getElementById('trophy');
  const nameInput = document.getElementById('nameInput');
  const menuButtons = menu.querySelectorAll('button[data-mode]');
  const lbPreview = document.getElementById('lbPreview');
  const viewLB = document.getElementById('viewLB');
  const seeLB = document.getElementById('seeLB');
  const lbEnd = document.getElementById('lbEnd');

  // --------- Game state
  let eggCount = 0, featherCount = 0, lives = 3, score = 0, streak = 0;
  let mode = null, playerName = 'Player';
  let running = false;
  let rafId = null;

  // --------- Configs
  const CONFIGS = {
    normal: {
      label: 'Normal',
      numStart: 8,
      speedMin: 0.6, speedMax: 1.6,
      chaosTurnChance: 0.002,
      leaveChance: 0.0008,
      otherSpawnRatio: 0.35,
      maxActors: 14,
      respawnDelay: [1200, 2600],
      basePoint: 1
    },
    chaos: {
      label: 'Chaos',
      numStart: 12,
      speedMin: 1.2, speedMax: 3.0,
      chaosTurnChance: 0.015,
      leaveChance: 0.0018,
      otherSpawnRatio: 0.55,
      maxActors: 20,
      respawnDelay: [600, 1500],
      basePoint: 1
    }
  };
  let config = {};

  // --------- Pen bounds
  function penSize() {
    const rect = pen.getBoundingClientRect();
    return { w: rect.width - 60, h: rect.height - 60 };
  }

  // --------- Entities
  const birdTypes = [
    { emoji:'üêî', type:'hen'     },
    { emoji:'üêì', type:'rooster' }
  ];
  const otherAnimals = [
    'ü¶Ü','üê§','ü¶â','üïäÔ∏è','ü¶Ö','ü¶¢','ü¶é',
    'üêÆ','üê∑','üê±','üê∂','üê¥','üê≠','ü¶ä','ü¶ù','üêª','üê∏','üêß'
  ];
  const actors = [];

  // --------- Audio (WebAudio, no external files)
  const AudioBus = {
    ctx: null,
    ensure(){
      if(this.ctx) return this.ctx;
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      return this.ctx;
    },
    // simple tone
    tone({freq=880, dur=0.08, type='square', vol=0.06}={}){
      try{
        const ctx = this.ensure();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = type; o.frequency.value = freq; g.gain.value = vol;
        o.connect(g).connect(ctx.destination); o.start();
        setTimeout(()=>o.stop(), dur*1000);
      }catch(e){}
    },
    // bonus bling
    arpeggio(base=660, steps=[0,7,12,19], dur=0.05){
      const ctx = this.ensure();
      let t = ctx.currentTime;
      steps.forEach(s=>{
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='triangle'; o.frequency.value = base * Math.pow(2, s/12);
        g.gain.setValueAtTime(0.08, t);
        g.gain.exponentialRampToValueAtTime(0.001, t+dur);
        o.connect(g).connect(ctx.destination); o.start(t); o.stop(t+dur);
        t += dur*0.8;
      });
    },
    // UFO siren (incoming) then descending crash
    ufoIncoming(){
      try{
        const ctx = this.ensure();
        const o1 = ctx.createOscillator(), g1 = ctx.createGain();
        const o2 = ctx.createOscillator(), g2 = ctx.createGain();
        o1.type='square'; o2.type='square';
        g1.gain.value=0.04; g2.gain.value=0.04;
        o1.connect(g1).connect(ctx.destination);
        o2.connect(g2).connect(ctx.destination);
        // whoop siren
        o1.frequency.setValueAtTime(440, ctx.currentTime);
        o1.frequency.exponentialRampToValueAtTime(660, ctx.currentTime+0.35);
        o2.frequency.setValueAtTime(660, ctx.currentTime);
        o2.frequency.exponentialRampToValueAtTime(440, ctx.currentTime+0.35);
        o1.start(); o2.start();
        setTimeout(()=>{ o1.stop(); o2.stop(); }, 360);
      }catch(e){}
    },
    ufoCrash(){
      try{
        const ctx = this.ensure();
        const o = ctx.createOscillator(); const n = ctx.createOscillator(); const g = ctx.createGain();
        o.type='sawtooth'; n.type='triangle';
        o.frequency.setValueAtTime(900, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(80, ctx.currentTime+1.2);
        n.frequency.setValueAtTime(60, ctx.currentTime);
        g.gain.value=0.07;
        o.connect(g); n.connect(g); g.connect(ctx.destination);
        o.start(); n.start();
        setTimeout(()=>{ o.stop(); n.stop(); }, 1300);
      }catch(e){}
    },
    start(){ this.tone({freq:660, dur:0.12, type:'triangle', vol:0.08}); },
    gameOver(){ this.tone({freq:220, dur:0.18, type:'sawtooth', vol:0.07}); },
    hitGood(){ this.tone({freq:540, dur:0.06, type:'square', vol:0.07}); },
    hitGood2(){ this.tone({freq:760, dur:0.06, type:'square', vol:0.07}); },
    hitBad(){ this.tone({freq:180, dur:0.12, type:'sawtooth', vol:0.07}); },
  };

  // Unlock audio on first user gesture
  window.addEventListener('pointerdown', ()=>{ try{ AudioBus.ensure().resume(); }catch(e){} }, { once:true, passive:true });

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display='block';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.style.display='none', 900);
  }

  // --------- HUD
  function renderHUD(){
    eggCountEl.textContent = eggCount;
    featherCountEl.textContent = featherCount;
    document.getElementById('score').textContent = score;
    document.getElementById('streak').textContent = streak;
    livesEl.textContent = '‚ù§Ô∏è'.repeat(lives) + 'üñ§'.repeat(3-lives);
    modeLabel.textContent = CONFIGS[mode]?.label ?? '‚Äî';
    playerLabel.textContent = playerName ?? '‚Äî';
    renderHighScoreBanner();
  }

  // --------- Spawning
  function randomStartPos(){
    const {w,h} = penSize();
    return { x: Math.random()*w + 30, y: Math.random()*h + 30 };
  }
  function randomSpeed(){
    const s = Math.random()*(config.speedMax-config.speedMin)+config.speedMin;
    return (Math.random()<0.5? -s : s);
  }
  function randomActorType(){
    const isOther = Math.random() < config.otherSpawnRatio;
    if(!isOther){
      return birdTypes[Math.floor(Math.random()*birdTypes.length)];
    }
    // 15% of "other" spawns are cows (rare & dangerous)
    if(Math.random() < 0.15){
      return { emoji:'üêÑ', type:'cow' };
    }
    const emoji = otherAnimals[Math.floor(Math.random()*otherAnimals.length)];
    return { emoji, type:'other' };
  }

  function createActor() {
    if(actors.length >= config.maxActors) return null;
    const data = randomActorType();

    const wrap = document.createElement('div');
    wrap.className = 'actor';
    wrap.dataset.type = data.type;

    const em = document.createElement('div');
    em.className = 'emoji';
    em.textContent = data.emoji;

    const hit = document.createElement('div');
    hit.className = 'hit';
    hit.title = (data.type==='hen' || data.type==='rooster') ? 'Click!' : (data.type==='cow' ? 'UFO bait!' : 'Do NOT click!');

    const {x,y} = randomStartPos();
    wrap.style.left = x + 'px';
    wrap.style.top  = y + 'px';

    wrap.dx = randomSpeed();
    wrap.dy = randomSpeed();

    // Cows: slower so they linger (40% speed) + halo
    if(data.type === 'cow'){
      wrap.dx *= 0.4; wrap.dy *= 0.4;
      em.classList.add('cowHalo');
    }

    hit.addEventListener('click', () => { if(running) handleActorSelection(wrap); });

    wrap.appendChild(hit);
    wrap.appendChild(em);
    pen.appendChild(wrap);
    actors.push(wrap);
    return wrap;
  }

  function removeActor(el){
    if(!el || !el.parentNode) return;
    el.style.opacity='0';
    setTimeout(()=>{ if(el.parentNode) el.parentNode.removeChild(el); }, 280);
    const i = actors.indexOf(el);
    if(i>=0) actors.splice(i,1);
  }

  function scheduleRespawn(){
    const [a,b] = config.respawnDelay;
    const delay = Math.random()*(b-a)+a;
    setTimeout(()=>{ if(running) createActor(); }, delay);
  }

  function leavePen(el){
    el.dataset.leaving = '1';
    el.style.opacity='0';
    setTimeout(()=>{ removeActor(el); if(running) scheduleRespawn(); }, 280);
  }

  function dropThing(symbol, x, y){
    const d = document.createElement('div');
    d.className = 'drop';
    d.textContent = symbol;
    d.style.left = x; d.style.top = y;
    pen.appendChild(d);
    d.animate([
      { transform:'translate(-50%,-50%)', opacity:1 },
      { transform:'translate(-50%,-90%)', opacity:0 }
    ], { duration: 700, easing:'cubic-bezier(.2,.9,.2,1)'});
    setTimeout(()=> d.remove(), 720);
  }

  // --------- Scoring & streaks
  function addPoints(n){ score += n; }
  function increaseStreak(){
    streak += 1;
    if(streak>0 && streak % 5 === 0){
      showFloatingBonus('+3', '#16a34a');
      score += 3;
      AudioBus.arpeggio(660);
    } else {
      AudioBus.hitGood();
    }
  }
  function resetStreak(){
    if(streak>=5) showFloatingBonus('Streak Broken', '#ef4444');
    streak = 0;
    AudioBus.hitBad();
  }
  function showFloatingBonus(text, color){
    const e = document.createElement('div');
    e.textContent = text;
    e.style.position='fixed';
    e.style.left = '50%'; e.style.top = '70px';
    e.style.transform='translateX(-50%)';
    e.style.background='#fff'; e.style.color = color || '#111';
    e.style.padding='6px 10px';
    e.style.borderRadius='10px';
    e.style.boxShadow='0 8px 18px #0003';
    e.style.zIndex='12';
    document.body.appendChild(e);
    e.animate([{opacity:1, transform:'translate(-50%,0)'},{opacity:0, transform:'translate(-50%,-16px)'}], {duration:900, easing:'ease-out'});
    setTimeout(()=>e.remove(), 920);
  }

  function loseLife(){
    if(lives<=0) return;
    lives--; renderHUD();
    document.body.classList.add('hurt');
    setTimeout(()=> document.body.classList.remove('hurt'), 200);
    showToast('Life lost! Only click üêî or üêì');
    AudioBus.hitBad();
    if(lives<=0){ endGame(); }
  }

  // --------- UFO sequence (incoming telegraph + crash + shake)
  function triggerUFO(x, y){
    if(!running) return;
    running = false;

    // INCOMING telegraph: purple border flash + siren
    ufoIncomingFlash();
    AudioBus.ufoIncoming();

    // Delay slightly, then animate crash
    setTimeout(()=>{
      const ufo = document.createElement('div');
      ufo.textContent = 'üõ∏';
      Object.assign(ufo.style, {
        position:'absolute', left:'-120px', top:'-120px',
        fontSize:'3.2rem', zIndex:99, pointerEvents:'none'
      });
      pen.appendChild(ufo);

      const cx = parseFloat(x), cy = parseFloat(y);
      ufo.animate([
        { transform:`translate(0,0) rotate(0deg)`, opacity:1 },
        { transform:`translate(${cx}px, ${cy}px) rotate(720deg) scale(2)`, opacity:0 }
      ], { duration: 1200, easing:'cubic-bezier(.3,.8,.4,1)'});

      // screen shake + crash sound
      pen.classList.add('shake');
      AudioBus.ufoCrash();
      setTimeout(()=> pen.classList.remove('shake'), 520);

      setTimeout(()=>{
        if(ufo.parentNode) ufo.remove();
        endGame();
      }, 1220);
    }, 350);
  }

  function ufoIncomingFlash(){
    const flash = document.createElement('div');
    Object.assign(flash.style, {
      position:'absolute', inset:'0', border:'6px solid var(--ufo)', borderRadius:'12px',
      boxShadow:'0 0 24px 8px rgba(139,92,246,.5) inset',
      opacity:'0', pointerEvents:'none', zIndex:'98'
    });
    pen.appendChild(flash);
    flash.animate([
      { opacity:0 },
      { opacity:1 },
      { opacity:0 }
    ], { duration: 320, easing:'ease-in-out' });
    setTimeout(()=> flash.remove(), 340);
  }

  // --------- Movement
  function tick(){
    if(!running){ rafId = requestAnimationFrame(tick); return; }

    const {w,h} = penSize();
    actors.forEach(el=>{
      if(el.dataset.leaving) return;

      if(Math.random() < config.chaosTurnChance){
        el.dx += (Math.random() - 0.5) * 0.8;
        el.dy += (Math.random() - 0.5) * 0.8;
        const mag = Math.hypot(el.dx, el.dy) || 1;
        const max = config.speedMax*1.2;
        if(mag>max){ el.dx = el.dx/mag*max; el.dy = el.dy/mag*max; }
      }

      let x = parseFloat(el.style.left);
      let y = parseFloat(el.style.top);

      x += el.dx; y += el.dy;

      if (x <= 8 || x >= w) el.dx *= -1;
      if (y <= 8 || y >= h) el.dy *= -1;

      el.style.left = x + 'px';
      el.style.top  = y + 'px';

      if(Math.random() < config.leaveChance){
        leavePen(el);
      }
    });

    rafId = requestAnimationFrame(tick);
  }

  // --------- Selection logic
  function handleActorSelection(actor){
    const type = actor.dataset.type;
    if(type === 'cow'){
      triggerUFO(actor.style.left, actor.style.top);
      return;
    }
    if(type === 'hen'){
      eggCount++; addPoints(config.basePoint); increaseStreak();
      renderHUD(); dropThing('ü•ö', actor.style.left, actor.style.top);
      AudioBus.hitGood2();
    } else if(type === 'rooster'){
      featherCount++; addPoints(config.basePoint); increaseStreak();
      renderHUD(); dropThing('ü™∂', actor.style.left, actor.style.top);
      AudioBus.hitGood();
    } else {
      resetStreak();
      loseLife();
    }
  }

  // --------- Aim Assist (tap anywhere)
  (function enableAimAssist(){
    const SELECT_RADIUS_PX = 70;
    const HIGHLIGHT_MS = 140;

    function penPointFromEvent(ev){
      const r = pen.getBoundingClientRect();
      return { x: ev.clientX - r.left, y: ev.clientY - r.top };
    }
    function distToActor(p, actor){
      const ax = parseFloat(actor.style.left);
      const ay = parseFloat(actor.style.top);
      return Math.hypot(p.x - ax, p.y - ay);
    }
    function flashRing(x, y, color){
      const ring = document.createElement('div');
      Object.assign(ring.style, {
        position:'absolute', left: (x-18)+'px', top:(y-18)+'px',
        width:'36px', height:'36px', borderRadius:'50%',
        border: `3px solid ${color}`, opacity:'0.9', pointerEvents:'none', zIndex: 5
      });
      pen.appendChild(ring);
      ring.animate([
        { transform:'scale(0.9)', opacity:0.9 },
        { transform:'scale(1.25)', opacity:0.0 }
      ], { duration: HIGHLIGHT_MS, easing:'ease-out' });
      setTimeout(()=> ring.remove(), HIGHLIGHT_MS+30);
    }
    function nearestActor(p){
      let best = null, bd = Infinity;
      for(const a of actors){
        if(a.dataset.leaving) continue;
        const d = distToActor(p, a);
        if(d < bd){ bd = d; best = a; }
      }
      return (bd <= SELECT_RADIUS_PX) ? best : null;
    }

    pen.addEventListener('pointerdown', (ev)=>{
      if(!running) return;
      if(ev.button !== 0) return;
      const p = penPointFromEvent(ev);
      const target = nearestActor(p);
      if(!target) return;

      const type = target.dataset.type;
      const color = (type==='hen'||type==='rooster') ? 'var(--ok)' : (type==='cow' ? 'var(--ufo)' : 'var(--warn)');
      flashRing(parseFloat(target.style.left), parseFloat(target.style.top), color);
      if('vibrate' in navigator && (type!=='hen' && type!=='rooster')) navigator.vibrate(40);
      handleActorSelection(target);
    }, { passive: true });
  })();

  // --------- Game flow
  function resetState(){
    eggCount = 0; featherCount = 0; lives = 3; score = 0; streak = 0;
    renderHUD();
    [...actors].forEach(a=>removeActor(a));
  }

  function startGame(selectedMode){
    mode = selectedMode; config = CONFIGS[mode];
    resetState();
    modeLabel.textContent = config.label;

    for(let i=0;i<config.numStart;i++){ createActor(); }

    running = true;
    menu.style.display='none';
    gameover.style.display='none';
    AudioBus.start();
    if(!rafId) tick();
  }

  function endGame(){
    running = false;
    finalEggs.textContent = eggCount;
    finalFeathers.textContent = featherCount;
    finalScore.textContent = score;
    saveScore(playerName, score);
    renderHighScoreBanner();
    AudioBus.gameOver();
    gameover.style.display='grid';
  }

  // --------- Username & menu
  function validName(s){ return !!s && s.trim().length>=3 && s.trim().length<=16; }
  nameInput.addEventListener('input', ()=>{
    const ok = validName(nameInput.value);
    menuButtons.forEach(b=> b.disabled = !ok);
  });
  menu.addEventListener('click', (e)=>{
    if(e.target.matches('button[data-mode]')){
      playerName = nameInput.value.trim();
      if(!validName(playerName)) return;
      playerLabel.textContent = playerName;
      startGame(e.target.getAttribute('data-mode'));
    }
  });
  restartBtn.addEventListener('click', ()=>{
    menu.style.display='grid';
    gameover.style.display='none';
    nameInput.value = playerName;
    nameInput.dispatchEvent(new Event('input'));
  });

  // --------- Leaderboard
  const LB_KEY = 'hrp_leaderboard_v1';
  function readLB(){
    try{
      const raw = localStorage.getItem(LB_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function writeLB(arr){
    try{ localStorage.setItem(LB_KEY, JSON.stringify(arr)); }catch(e){}
  }
  function saveScore(name, sc){
    const arr = readLB();
    arr.push({ name: (name||'Player').slice(0,16), score: sc|0, date: Date.now() });
    arr.sort((a,b)=> b.score - a.score || a.date - b.date);
    writeLB(arr.slice(0,20));
  }
  function bestScore(){
    const arr = readLB();
    return arr.length ? arr[0] : null;
  }
  function renderHighScoreBanner(){
    const best = bestScore();
    trophy.textContent = best ? `üèÜ High Score: ${best.name} ‚Äî ${best.score}` : 'üèÜ High Score: ‚Äî';
  }
  function lbHTML(arr){
    if(!arr.length) return '<p class="small">No scores yet. Be the first!</p>';
    const rows = arr.map((r,i)=>`
      <tr>
        <td class="rank">${i+1}.</td>
        <td>${escapeHTML(r.name)}</td>
        <td class="score">${r.score}</td>
      </tr>`).join('');
    return `<table><thead><tr><th class="rank">#</th><th>Name</th><th class="score">Score</th></tr></thead><tbody>${rows}</tbody></table>`;
  }
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function showLB(container){ container.innerHTML = lbHTML(readLB()); container.style.display='block'; }
  viewLB.addEventListener('click', ()=> showLB(lbPreview));
  seeLB.addEventListener('click', ()=> showLB(lbEnd));

  // --------- Init
  renderHUD();
  nameInput.value = localStorage.getItem('hrp_last_name') || '';
  nameInput.dispatchEvent(new Event('input'));
  nameInput.addEventListener('change', ()=> {
    if(validName(nameInput.value)) localStorage.setItem('hrp_last_name', nameInput.value.trim());
  });

  rafId = requestAnimationFrame(tick);
  window.addEventListener('resize', ()=>{});
</script>
</body>
</html>
